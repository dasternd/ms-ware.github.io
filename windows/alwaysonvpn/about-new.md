# Общее понимание о решении Always On VPN

**VPN** (**V**irtual **P**rivate **N**etwork) - наиболее распространенный способ организации безопасного удаленного доступа пользователям к корпоративным ресурсам за периметром корпоративной сети. А поскольку из года в год все больше сотрудников переходят на удаленный формат работы, перед компаниями стоит задача предоставить эффективный и безопасный удаленный доступ.

Данная обзорная статья посвещена технологии Always On VPN от Microsoft, которая появилась в Windows 10 и является аналогом класического VPN со своими плюсами и минусами.


## Always On VPN замена DirectAccess

В качестве альтернативы VPN, Microsoft в Windows 7 и Windows Server 2008 R2 представила свою технологию удаленного доступа DirectAccess. 

Технология DirectAccess позволяет использовать безопасное подключение компьютеров сотрудников к корпоративной сети по протоколу HTTPS (TCP 443) без участия пользователя и установки дополнительных клиентов. Технология работает незаметно для пользователя и гарантирует, что клиентский компьютер всегда подключен к корпоративной сети при наличие интернета на компьютере. Тем самым дополнительно позволяет техническому персоналу управлять такими компьютерами, как если бы они находились в локальной сети.

Но есть и свои минусы данной технологии. В качестве операционной системы необходимо использовать только Enterprise-редакцию или Ultimate в Windows 7. Данное решение базируется на использовании протокола IPv6.

С выходом Windows 10 появилось еще одно решение по организации удаленного доступа сотрудникам к корпоративным ресурсам - это технология Always On VPN.

Always On VPN в Windows 10 это следующий этап развития решения Microsoft для организации безопасного доступа клиентов к корпоративной сети удалено. Always On VPN призвано заменить DirectAccess.

С официальной документация по Always On VPN можно ознакомиться на [сайте Microsoft](https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/). На данном сайте представлен авторский вариант последовательности шагов по настройки Always On VPN основанный на опыте в коммерческих проектах.


## Общий принцип работы Always On VPN

**Always On VPN** - это технология только для Windows 10. Требуется **Windows 10 Anniversary Update** (версия **1607**) или новее. При этом можно использовать редакцию как Pro, так и Enterprise. К тому же в некоторых случаях можно не подключать компьютер к Windows Server Active Directory.

В качестве VPN сервера и RADIUS сервера можно использовать решения от других производителей. Но в данной статьи в качестве VPN сервера будет использоваться Windows Server с установленной ролью Routing and Remote Access, а в качестве RADIUS сервера будет использоваться Windows Server с установленной ролью Network Policy Server.

Устройство VPN, должен поддерживать маршрутизацию **IKEv2**, который с одной стороны является плюсом. IKEv2 может автоматически восстанавливать соединение, если происходит прерывание сетевого соединения. Но в качестве недостатка IKEv2 можно отнести то, что используются порты **UDP 500** и **UDP 4500**, которые могут быть закрыты на сетевом оборудовании, если пользователь со своим компьютером будет работать, например, в кафе или в номере гостиницы, где как правило доступны только порты TCP 80 и TCP 443.

В качестве резервного протокола можно использовать **SSTP**, который использует **TCP 443**, по сути HTTPS-протокол, но такое соединение работает не очень хорошо и не подерживает **Device Tunnel**.

Чтобы понять общий принцип работы Always On VPN, обратимся к схеме Microsoft с описанием последовательностей, что происходит при подключении.

Схема инфраструктуры, которая необходима для развертывания Always On VPN.

![Общая схема Always On VPN](/../img/aovpn/aovpn-overview.jpg "Общая схема организации решения Always On VPN")

1. Используя общедоступные DNS-серверы, VPN-клиент Windows 10 выполняет запрос разрешения имен для IP-адреса VPN-шлюза.
2. Используя IP-адрес, возвращенный службой DNS, VPN-клиент отправляет запрос на подключение к VPN-шлюзу.
3. VPN-шлюз также настраивается как клиент протокол RADIUS (RADIUS). VPN-клиент RADIUS отправляет запрос на подключение к серверу NPS организации или организации для обработки запроса на подключение.
4. Сервер политики сети обрабатывает запрос на подключение, включая выполнение авторизации и проверку подлинности, а также определяет, следует ли разрешать или запрещать запрос на соединение.
5. Сервер политики сети перенаправляет ответ Access-Accept или Access-DENY на VPN-шлюз.
6. Подключение инициируется или прерывается в зависимости от ответа, полученного от сервера политики сети.


## Возможности Always On VPN

Always On VPN позволяет использовать условный доступ и проверку работоспособности системы с использование **N**etwork **P**olicy **S**erver (**NPS**). Существует интеграция с **Windows Hello for Business** и **Azure Multifactor Authentication**.

При этом отличительной особенностью Always On VPN является то, что можно не использовать Windows Server в качестве устройства VPN, а также использовать стороннее RADIUS продукты для аутентификации. 

К дополнительным возможностям можно отнести 
	– Фильтрация трафика
	– VPN, запускаемый приложением
	– Условный доступ (Azure Active Directory Premium) и соответствие устройств

Полный список улучшений в Windows 10 Always On VPN можно найти на веб-сайте Microsoft 
https://docs.microsoft.com/ru-ru/windows-server/remote/remote-access/vpn/always-on-vpn/always-on-vpn-enhancements


## Always On VPN: Device Tunnel vs Always On VPN User Tunnel

Для настройки подключения Always On VPN необходимо создать VPN-профиль и установить на Windows 10. Существует два типа: профиль пользователя (**User Tunnel**) и профиль устройства (**Device Tunnel**).

Профиль пользователя работает индивидуально для каждого пользователя на устройстве и активируется после входа пользователя в систему под своей учетной записью. Профиль устройства работает для компьютера в целом и активируется до входа пользователя в систему.

Для работы профиля устройства необходима редакция **Windows 10 Enterprise**, для профиля пользователя достаточно редакции **Windows 10 Pro**.

В таблице приведен краткий перечен различий между профилем устройства и профилем пользователя.

|   Device Tunnel   |	User Tunnel |
|-------------------|---------------|
| Невидимо в GUI    | Отображается в GUI |
| Без NPS           | Необходим NPS |
| Сертификат проверятеся на RRAS    | Сертификат проверяется на NPS |
| [Нельзя отозвать сертификат в Windows Server 2012R2, для других необходимо устанавливать обновления и создавать ключ в реестре на VPN-серверах](https://directaccess.richardhicks.com/2019/06/20/always-on-vpn-device-tunnel-and-certificate-revocation/) | Можно отозвать сертификат пользователя
Windows 10 Enterprise (только доменные компьютеры)  | Windows 10 Pro (можно использовать недоменные компьютеры из рабочей группы) |
| Не возможно использовать условный доступ  | Можно использовать условный доступ через Azure |
| Нет MFA           | Есть MFA |
| Использует только IKEv2 (UDP 500, UDP 4500)   | Можно использовать SSTP (TCP 443) |
| Можно включить фильтрацию трафика, в таком случае весь входящий трафик будет заблокирован. Как вариант использовать маршруты с префиксом IP-адреса /32.      |   |

Нужно отметить что профиль на устройство и профиль на пользователя работают несколько иначе. Для работы Always On VPN Device Tunnel не нужен RADIUS-сервер, т.к. авторизация идет на VPN-сервере.


## Схема работы User Tunnel

![Тунель пользователя](/../img/aovpn/aovpn-userTunnel.jpg "Общая схема работы тунеля для пользователей")

1. Клиент VPN отправляет запрос на подключение на внешний IP-адрес VPN-сервера
2. Краевой брандмауэр передает запрос на подключение к внешнему интерфейсу VPN-сервера
3. VPN-сервер передает запрос на подключение на сервер RADIUS. Запрос на подключение выходит через внутренний интерфейс VPN-сервера и проходит через внутренний брандмауэр
4. Сервер RADIUS получает и аутентистиирует запрос на подключение
5. Сервер RADIUS возвращает прием или отказ в ответе на VPN-сервер
VPN-сервер позволяет или отказывает в запросе на подключение на основе ответа с сервера RADIUS


## Схема работы Device Tunnel

![Тунель устройства](/../img/aovpn/aovpn-deviceTunnel.jpg "Общая схема работы тунеля для устройства")

1. Клиент VPN отправляет запрос на подключение на внешний IP-адрес VPN-сервера
2. Краевой брандмауэр передает запрос на подключение к внешнему интерфейсу VPN-сервера
3. VPN-сервер проверяет сертификат проверки подлинности компьютера клиента и позволяет или отрицает запрос на подключение


## Управление Always On VPN

Always On VPN разработан для управления с помощью Mobile Device Management (MDM), в частности Microsoft Intune. Но можно использовать сторонние платформы MDM или Microsoft Endpoint Configuration Manager, ранее известный как System Center Configuration Manager (SCCM) для распространения VPN-профилей.

После краткой теоритической части, можно переходить к практической.

