# Настройка Always On VPN по шагам

Данная статья состоит из пошаговых инструкций по настройки решения Always On VPN, которая может со временем дополняться и дорабатываться.

## Подготовка демо стенда

Для настройки и демонстрации решения Always On VPN понадобиться демо-среда. В силу ограничения аппаратных ресурсов будет создано ограниченное количество ВМ, которые будут совмещать несколько ролей, что в продуктивной среде не рекомендуется и даже нежелательно.

## Параметры виртуальных машин

В таблице представлены характеристики виртуальных машин которые используются для демонстрации решения Always On VPN.

| VM    | OS    | Роль  | HDD, Gb   | RAM, Mb   | HDD, Gb   | LAN   |
|-------|-------|-------|-----------|-----------|-----------|-------|
| DC    | Windows Server 2019 Standart  | AD DS/DNS/AD CS   |16 | 515-2048    |16 | 192.168.100.1 (PrivateLAN) |
| NAP   | Windows Server 2019 Standart  | NPS   | 16    | 515-2048  | 16    | 192.168.100.2 (PrivateLAN) |
| VPN   | Windows Server 2019 Standart  | RAS   | 16    | 515-2048  | 16    | 192.168.100.3 (PrivateLAN), 10.10.10.3 (PrivateLAN_VLAN2) |
| W10   | Windows 10 Enterprise	Клиент  |       | 16    | 515-2048  | 16    | 192.168.0.101 (PrivateLAN), 10.10.10.101 (PrivateLAN_VLAN2) |

Чтобы эмулировать доступ клиентского компьютера как в локальной сети, так и за ее периметром, были созданы два виртуальных сетевых адаптеров (Private Type) на VPN-сервере и на клиентском компьютере. При этом второй виртуальный сетевой адаптер был настроен на VLAN, тем самым ограждая "локальный доменный трафик" и иметированый "внешний интернет" трафик между этими виртуальными машинами.


## Параметры тестовой среды
- Внутренний домен: ms-ware.ru (192.168.100.x/24)
- DMZ: 10.10.10.x/24
- Внешний домен: ms-ware.ru 
- Адрес подключения AlwaysOn VPN: aovpn.ms-ware.ru (10.10.10.3)
(c:\windows\system32\drivers\etc\hosts)
[10.10.10.3	aovpn.ms-ware.ru]
- AD DC/DNS/DHCP/AD CS: dc.ms-ware.ru (192.168.100.1)
- Адрес размещения crl-файла: http://pki.ms-ware.ru
- NPS (RADIUS-сервер): nap.ms-ware.ru (192.168.100.2)
- RAS (VPN-сервер в DMZ): vpn.ms-ware.ru (192.168.100.3/10.10.10.3)

> **Предупреждение**. 
> [Прежде чем приступить к работе, обязательно включите IPv6 на VPN-сервере. В противном случае соединение не может быть установлено, и отображается сообщение об ошибке.](https://docs.microsoft.com/ru-ru/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/vpn-deploy-ras) 

- Доменный ПК: W10-01.ms-ware.local (Enterprise)
- Пользователи AlwaysOnVPN: ms-ware\User1; ms-ware\User2
- Доступность портов на VPN-сервере: UDP 500, UDP 4500.


